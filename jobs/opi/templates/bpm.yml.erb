processes:
  - name: opi
    executable: /var/vcap/packages/eirini/bin/opi
    args:
    - connect
    - --config=/var/vcap/jobs/opi/config/opi.yml
    env:
      <% host = p("opi.kube_service_host", "") %>
      <%= "KUBERNETES_SERVICE_HOST: \"#{host}\"" unless host.empty? %>
      <% port = p("opi.kube_service_port", "") %>
      <%= "KUBERNETES_SERVICE_PORT: \"#{port}\"" unless port.empty? %>
    <% unless p("opi.k8s.host_url", "").empty? %>
    # The ServiceAccount admission controller has to be enabled.
    # https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/#accessing-the-api-from-a-pod
    additional_volumes:
    - path: /var/run/secrets/kubernetes.io/serviceaccount/token
      mount_only: true
    - path: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      mount_only: true
    - path: /var/run/secrets/kubernetes.io/serviceaccount/namespace
      mount_only: true
    <% end %>
